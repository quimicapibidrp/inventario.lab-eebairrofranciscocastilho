<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Invent√°rio Laborat√≥rio E.E Bairro Francisco Castilho</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GERAIS --- */
        :root {
            --primary: #006989; 
            --primary-dark: #004d66; 
            --accent: #00b4d8;
            --bg-body: #f4f6f8; 
            --surface: #ffffff; 
            --input-bg: #f8fafc;
            --text-main: #1e293b; 
            --text-light: #64748b; 
            --border: #e2e8f0;
            --success: #10b981; 
            --warning: #f59e0b; 
            --danger: #ef4444;
            --radius-lg: 24px; 
            --radius-md: 16px; 
            --radius-sm: 8px;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        
        body { 
            font-family: 'Work Sans', sans-serif; 
            background: var(--bg-body); 
            color: var(--text-main); 
            line-height: 1.6; 
            min-height: 100vh; 
            padding-bottom: 80px;
        }

        /* --- HEADER --- */
        .header { 
            background: var(--surface); 
            padding: 1.5rem 0; 
            box-shadow: var(--shadow-sm); 
            border-bottom-left-radius: 30px; 
            border-bottom-right-radius: 30px; 
            margin-bottom: 2rem; 
            position: relative; 
            z-index: 10; 
        }
        
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        
        .header-content { 
            display: flex; align-items: center; justify-content: space-between; 
            flex-direction: column; gap: 1.2rem; 
        }

        .branding-area {
            display: flex; align-items: center; justify-content: center;
            flex-direction: column; text-align: center; gap: 1.2rem;
        }
        
        .logo-img { max-height: 100px; width: auto; object-fit: contain; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.05)); }
        
        .logo-text h1 { 
            font-family: 'Space Mono', monospace; font-size: 1.35rem; 
            font-weight: 700; color: var(--primary); line-height: 1.2; 
            margin-bottom: 0.25rem; letter-spacing: -0.02em;
        }
        .logo-text p { color: var(--text-light); font-size: 0.9rem; font-weight: 500; }
        
        @media (min-width: 768px) {
            .header-content { flex-direction: row; }
            .branding-area { flex-direction: row; text-align: left; gap: 2rem; }
            .logo-text h1 { font-size: 2.2rem; } 
            .logo-text p { font-size: 1.1rem; } 
            .logo-img { max-height: 120px; }
        }

        /* --- LOGIN --- */
        .auth-container { display: flex; align-items: center; }

        .btn-google {
            background: white; color: #3c4043;
            border: 1px solid #dadce0; border-radius: 20px;
            padding: 8px 16px 8px 8px;
            font-size: 14px; font-weight: 500; font-family: 'Google Sans', arial, sans-serif;
            cursor: pointer; display: flex; align-items: center; gap: 10px;
            transition: all 0.2s; box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .btn-google:hover { background: #f7fafe; border-color: #d2e3fc; box-shadow: 0 1px 3px rgba(0,0,0,0.2); }
        .google-icon { width: 18px; height: 18px; }

        .user-chip {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 6px 12px 6px 6px;
            border-radius: 24px; border: 1px solid var(--border);
            box-shadow: var(--shadow-sm);
        }
        .avatar { width: 32px; height: 32px; border-radius: 50%; object-fit: cover; }
        .user-details { display: flex; flex-direction: column; line-height: 1.1; margin-right: 8px; }
        .u-name { font-size: 0.85rem; font-weight: 700; color: var(--text-main); }
        .u-role { font-size: 0.7rem; text-transform: uppercase; color: var(--primary); font-weight: 600; }
        .btn-logout { border: none; background: none; color: var(--danger); font-size: 0.8rem; font-weight: 600; cursor: pointer; }
        .btn-config { width: 30px; height: 30px; border-radius: 50%; border: none; background: var(--input-bg); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-config:hover { background: var(--primary); color: white; transform: rotate(45deg); }

        /* --- ALERTA POL√çTICA --- */
        .warning-box {
            background: #fffbeb; border: 1px solid #fcd34d; color: #92400e;
            padding: 1rem; border-radius: 12px; margin-bottom: 2rem;
            display: flex; justify-content: space-between; align-items: start;
            box-shadow: var(--shadow-sm);
        }

        /* --- CONTROLES --- */
        .dashboard-card { 
            background: var(--surface); border-radius: var(--radius-lg); 
            padding: 1.75rem; box-shadow: var(--shadow-md); 
            margin-bottom: 2rem; border: 1px solid var(--border); 
        }
        
        .top-actions { 
            display: flex; justify-content: flex-end; align-items: center; 
            gap: 1rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); 
            padding-bottom: 1.2rem; flex-wrap: wrap; 
        }
        
        .admin-only { display: none; }

        .btn-link { 
            background: none; border: none; cursor: pointer; 
            color: var(--text-light); font-size: 0.9rem; font-weight: 600; 
            display: flex; align-items: center; gap: 0.5rem; 
            padding: 0.5rem; border-radius: var(--radius-sm);
        }
        .btn-link:hover { color: var(--primary); background: var(--input-bg); }

        .controls-wrapper { display: flex; flex-direction: column; gap: 1.2rem; }
        .search-group { display: flex; gap: 1rem; flex-direction: column; width: 100%; }
        .input-wrapper { position: relative; width: 100%; }

        .search-input, .filter-select { 
            width: 100%; padding: 0.9rem 1rem 0.9rem 3rem; 
            font-size: 1rem; border: 1px solid var(--border); 
            background: var(--input-bg); border-radius: var(--radius-md); font-family: inherit; 
        }
        .filter-select { padding-left: 1.2rem; cursor: pointer; }
        .search-icon { position: absolute; left: 1.1rem; top: 50%; transform: translateY(-50%); color: var(--text-light); pointer-events: none; }

        .btn-primary { 
            width: 100%; padding: 0.9rem 1.5rem; border: none; border-radius: var(--radius-md); 
            font-weight: 600; font-size: 0.95rem; cursor: pointer; 
            display: inline-flex; align-items: center; justify-content: center; gap: 0.6rem; 
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            color: white; 
        }
        .btn-secondary { padding: 0.9rem 1.5rem; border: 1px solid var(--border); border-radius: var(--radius-md); font-weight: 600; background: white; cursor: pointer; }
        .btn-danger { background: var(--danger); color: white; border: none; padding: 0.9rem 1.5rem; border-radius: var(--radius-md); font-weight: 600; cursor: pointer; }

        @media (min-width: 768px) {
            .controls-wrapper { flex-direction: row; }
            .search-group { flex-direction: row; flex: 1; }
            .btn-primary { width: auto; min-width: 200px; }
        }

        /* --- TABELA --- */
        .table-wrapper { 
            background: var(--surface); border-radius: var(--radius-lg); 
            box-shadow: var(--shadow-sm); overflow: hidden; border: 1px solid var(--border); 
        }
        .table-responsive { width: 100%; overflow-x: auto; }
        table { width: 100%; border-collapse: collapse; min-width: 850px; }
        th { background: #f8fafc; color: var(--text-light); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; padding: 1.2rem; text-align: left; border-bottom: 2px solid var(--border); }
        td { padding: 1.2rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.95rem; vertical-align: middle; }
        
        .badge { padding: 0.35rem 0.85rem; border-radius: 50px; font-size: 0.75rem; font-weight: 700; text-transform: uppercase; }
        .badge-type { background: #e0f2fe; color: #0284c7; }
        .badge-alto { background: #dcfce7; color: #166534; }
        .badge-med { background: #ffedd5; color: #c2410c; }
        .badge-low { background: #fee2e2; color: #b91c1c; }

        .action-buttons { display: flex; gap: 0.6rem; }
        .btn-icon { width: 32px; height: 32px; border-radius: 8px; border: 1px solid transparent; background: transparent; color: var(--text-light); cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .btn-icon:hover { background: var(--bg-body); color: var(--primary); border-color: var(--border); }
        .btn-icon.delete:hover { background: #fff5f5; color: var(--danger); border-color: #fed7d7; }

        /* --- MODAIS --- */
        .modal { display: none; position: fixed; inset: 0; background: rgba(15, 23, 42, 0.4); backdrop-filter: blur(8px); justify-content: center; align-items: center; z-index: 1000; }
        .modal.active { display: flex; }
        .modal-content { background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); width: 95%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); }
        .modal-lg { max-width: 800px; }
        .modal-md { max-width: 650px; } 

        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
        
        /* Abas */
        .tabs { display: flex; gap: 0.5rem; background: var(--input-bg); padding: 0.5rem; border-radius: 16px; margin-bottom: 1.5rem; border: 1px solid var(--border); }
        .tab-btn { flex: 1; padding: 0.8rem; border: none; background: transparent; border-radius: 12px; cursor: pointer; font-weight: 600; color: var(--text-light); transition: all 0.2s; }
        .tab-btn.active { background: white; color: var(--primary); box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }

        /* Lista Tempor√°ria */
        .staging-list { display: flex; flex-direction: column; gap: 0.8rem; margin: 1rem 0; max-height: 400px; overflow-y: auto;}
        .staging-item { background: var(--input-bg); border: 1px solid var(--border); padding: 1rem; border-radius: 12px; display: flex; align-items: center; justify-content: space-between; gap: 1rem; }
        .staging-info h4 { margin: 0; font-size: 1rem; font-weight: 600; }
        .staging-info span { font-size: 0.85rem; color: var(--text-light); }
        .form-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 1.5rem; padding-top: 1.5rem; border-top: 1px solid var(--border); }
        
        .form-col { display: flex; flex-direction: column; gap: 1rem; }
        .form-input { padding: 0.8rem; border: 1px solid var(--border); border-radius: 8px; background: var(--input-bg); width: 100%; transition: all 0.2s; }
        .form-input:focus { border-color: var(--accent); background: var(--surface); outline: none; box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1); }

        /* --- FERRAMENTAS DE EDI√á√ÉO DE SELECTS --- */
        .dynamic-control-group { display: flex; gap: 0.5rem; align-items: center; } 
        .dynamic-control-group select { flex: 1; border-top-right-radius: 4px; border-bottom-right-radius: 4px; }
        .tools-wrapper { display: flex; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; padding: 2px; gap: 2px; }
        .btn-mini { 
            width: 32px; height: 32px; background: transparent; border: none; 
            border-radius: 6px; cursor: pointer; color: var(--text-light); 
            display: flex; align-items: center; justify-content: center; font-size: 1rem;
            transition: all 0.2s; 
        }
        .btn-mini:hover { background: #e0f2fe; color: var(--primary); } 
        .btn-mini.danger:hover { background: #fee2e2; color: var(--danger); }

        /* --- PRINT --- */
        @media print {
            body { background: white; padding: 0; margin: 0; color: black; -webkit-print-color-adjust: exact; }
            .header { box-shadow: none; margin: 0; padding: 10px 0; border-radius: 0; background: none; }
            .header-content { flex-direction: column !important; align-items: center !important; text-align: center !important; gap: 5px !important; }
            .branding-area { flex-direction: column !important; }
            .logo-img { max-height: 70px !important; margin-bottom: 5px; display: block !important; }
            .logo-text { width: 100%; text-align: center; }
            .logo-text h1 { font-size: 14pt !important; white-space: nowrap; color: black !important; margin: 0 !important; display: block; font-weight: bold; text-align: center; }
            .logo-text p { display: none; } 
            
            .search-section, .btn-primary, .btn-secondary, .btn-icon, .action-buttons, .modal, .top-actions, .auth-container, #statusMsg, #policyAlert, .admin-only, .action-td { display: none !important; }
            
            .table-wrapper { border: 1px solid #000; box-shadow: none; border-radius: 0; margin-top: 15px; }
            table { width: 100%; min-width: 100%; border-collapse: collapse; }
            th, td { border: 1px solid #999; padding: 6px 8px; font-size: 9pt; color: black; }
            thead { display: table-header-group; background: #ddd !important; }
            tr { page-break-inside: avoid; }
            .badge { border: none !important; background: none !important; color: black !important; padding: 0; font-weight: normal; }
            .container { max-width: 100%; padding: 0; margin: 0; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <div class="header-content">
                <div class="branding-area">
                    <img src="logo.png" alt="Logo Francisco Castilho" class="logo-img" onerror="this.style.display='none'">
                    <div class="logo-text">
                        <h1>Invent√°rio do Laborat√≥rio E.E Bairro Francisco Castilho</h1>
                        <p>Criado Por Alunos do Programa Institucional de Bolsas de Incia√ß√£o √† Doc√™ncia 2024-2026</p>
                    </div>
                </div>

                <div id="authContainer" class="auth-container">
                    </div>
            </div>
        </div>
    </header>

    <main class="container">
        
        <div id="policyAlert" class="warning-box">
            <div style="display:flex; gap:1rem; align-items:start;">
                <span style="font-size:1.5rem;">‚ö†Ô∏è</span>
                <div>
                    <strong>Pol√≠tica de Quantidade</strong>
                    <p style="font-size:0.9rem; margin-top:0.2rem;">
                        Mantenha em estoque apenas a quantidade necess√°ria para o semestre letivo. 
                        O excesso de reagentes vence e gera res√≠duos qu√≠micos caros para descarte.
                    </p>
                </div>
            </div>
            <button type="button" onclick="document.getElementById('policyAlert').style.display='none'" 
                    style="background:none; border:none; cursor:pointer; font-size:1.2rem; opacity:0.6;" title="Fechar aviso">‚úï</button>
        </div>

        <div class="dashboard-card search-section">
            <div class="top-actions">
                <button class="btn-link" onclick="window.print()">üñ®Ô∏è Imprimir</button>
                <button id="btnImport" class="btn-link admin-only" onclick="importData()">üìÇ Importar</button>
                <button id="btnBackup" class="btn-link admin-only" onclick="exportBackup()">üíæ Backup</button>
            </div>

            <div class="controls-wrapper">
                <div class="search-group">
                    <div class="input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar reagente, vidraria...">
                    </div>
                    <div style="min-width: 200px;">
                        <select id="filterType" class="filter-select">
                            <option value="Todos">Todos os Tipos</option>
                        </select>
                    </div>
                </div>
                
                <button id="btnEditInventory" type="button" class="btn-primary admin-only" onclick="openManagementModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><line x1="12" y1="8" x2="12" y2="16"></line><line x1="8" y1="12" x2="16" y2="12"></line></svg>
                    Editar Invent√°rio
                </button>
            </div>
            <div id="statusMsg" style="text-align: right; font-size: 0.75rem; color: var(--text-light); margin-top: 1rem;">Carregando sistema...</div>
        </div>

        <div class="table-wrapper">
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Localiza√ß√£o</th>
                            <th>Nome</th>
                            <th>Quantidade</th>
                            <th>Status</th>
                            <th id="colActions" class="admin-only">A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="managementModal" class="modal">
        <div class="modal-content modal-lg">
            <div class="modal-header">
                <h2 style="color: var(--primary);">Editar Invent√°rio</h2>
                <button type="button" onclick="closeModal('managementModal')" style="border:none; background:none; font-size:1.5rem; cursor:pointer;">‚úï</button>
            </div>

            <div class="tabs">
                <button class="tab-btn active" onclick="switchTab('add')">Adicionar (Lote)</button>
                <button class="tab-btn" onclick="switchTab('remove')">Remover (Lote)</button>
            </div>

            <div id="tab-add" class="tab-content active">
                <div style="text-align: center; margin-bottom: 1.5rem; padding: 1rem; background: var(--bg-body); border-radius: 12px;">
                    <p style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.9rem;">Adicione itens √† lista tempor√°ria. Eles s√≥ ser√£o salvos no banco quando confirmar.</p>
                    <button type="button" class="btn-primary" onclick="openStagingItemForm()" style="width: auto;">
                        + Adicionar Novo Item √† Lista
                    </button>
                </div>

                <div id="stagingArea" class="staging-list">
                    <div style="text-align: center; color: var(--text-light); padding: 2rem;">A lista de adi√ß√£o est√° vazia.</div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="clearStaging()">Cancelar / Limpar</button>
                    <button type="button" class="btn-primary" onclick="commitStagedItems()">Gravar no Banco de Dados</button>
                </div>
            </div>

            <div id="tab-remove" class="tab-content">
                <p style="margin-bottom: 1rem; color: var(--text-light); font-size: 0.9rem;">Selecione os itens antigos que deseja remover permanentemente:</p>
                <input type="text" id="deleteSearch" class="search-input" placeholder="Filtrar lista de exclus√£o..." oninput="renderDeleteList()">
                <div id="deleteListArea" class="staging-list"></div>
                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal('managementModal')">Cancelar</button>
                    <button type="button" class="btn-danger" onclick="confirmBatchDelete()">Excluir Selecionados</button>
                </div>
            </div>
        </div>
    </div>

    <div id="itemModal" class="modal" style="z-index: 1100;">
        <div class="modal-content modal-md">
            <div class="modal-header">
                <h3 id="modalTitle">Dados do Item</h3>
                <button type="button" onclick="closeModal('itemModal')" style="border:none;background:none;font-size:1.5rem;cursor:pointer;">&times;</button>
            </div>
            <form id="itemForm" class="form-col">
                <div class="form-col">
                    <label style="font-size:0.8rem; font-weight:700;">Nome do Item</label>
                    <input type="text" id="nome" class="form-input" required>
                </div>
                
                <div class="form-col">
                    <label style="font-size:0.8rem; font-weight:700;">Tipo</label>
                    <div class="dynamic-control-group">
                        <select id="tipo" class="form-input"></select>
                        <div class="tools-wrapper">
                            <button type="button" class="btn-mini" onclick="manageOption('type', 'add')" title="Adicionar">+</button>
                            <button type="button" class="btn-mini" onclick="manageOption('type', 'edit')" title="Editar">‚úé</button>
                            <button type="button" class="btn-mini danger" onclick="manageOption('type', 'remove')" title="Remover">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div class="form-col">
                    <label style="font-size:0.8rem; font-weight:700;">Localiza√ß√£o</label>
                    <div class="dynamic-control-group">
                        <select id="local" class="form-input"></select>
                        <div class="tools-wrapper">
                            <button type="button" class="btn-mini" onclick="manageOption('loc', 'add')" title="Adicionar">+</button>
                            <button type="button" class="btn-mini" onclick="manageOption('loc', 'edit')" title="Editar">‚úé</button>
                            <button type="button" class="btn-mini danger" onclick="manageOption('loc', 'remove')" title="Remover">‚úï</button>
                        </div>
                    </div>
                </div>
                
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:1.5rem;">
                    <div class="form-col">
                        <label style="font-size:0.8rem; font-weight:700;">Qtd</label>
                        <input type="number" id="qtd" class="form-input" required>
                    </div>
                    
                    <div class="form-col">
                        <label style="font-size:0.8rem; font-weight:700;">Unidade</label>
                        <div class="dynamic-control-group">
                            <select id="unidade" class="form-input"></select>
                            <div class="tools-wrapper">
                                <button type="button" class="btn-mini" onclick="manageOption('unit', 'add')" title="Adicionar">+</button>
                                <button type="button" class="btn-mini" onclick="manageOption('unit', 'edit')" title="Editar">‚úé</button>
                                <button type="button" class="btn-mini danger" onclick="manageOption('unit', 'remove')" title="Remover">‚úï</button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-col">
                    <label style="font-size:0.8rem; font-weight:700;">Status</label>
                    <select id="status" class="form-input">
                        <option value="Alto">Alto</option>
                        <option value="Satisfat√≥rio">Satisfat√≥rio</option>
                        <option value="Cr√≠tico!">Cr√≠tico!</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary" style="justify-content:center; margin-top:1rem;">OK / Salvar</button>
            </form>
        </div>
    </div>

    <div id="confirmDeleteModal" class="modal" style="z-index: 1200;">
        <div class="modal-content modal-md">
            <h2 style="color: var(--danger); margin-bottom:1rem;">Confirmar Exclus√£o</h2>
            <p>Os itens selecionados ser√£o apagados permanentemente.</p>
            <div class="form-actions">
                <button type="button" class="btn-secondary" onclick="closeModal('confirmDeleteModal')">Cancelar</button>
                <button type="button" class="btn-danger" onclick="executeBatchDelete()">Confirmar</button>
            </div>
        </div>
    </div>

    <div id="adminModal" class="modal">
        <div class="modal-content modal-md">
            <div class="modal-header"><h3>Gerenciar Usu√°rios</h3><button type="button" onclick="closeModal('adminModal')" style="border:none;background:none;font-size:1.2rem;cursor:pointer;">‚úï</button></div>
            <div id="usersList" style="max-height: 300px; overflow-y: auto;">Carregando...</div>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, getDoc, setDoc, query, orderBy, Timestamp, writeBatch } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyC3QfyB6u3MUbAsDry4W6cMDDdLHxFEWHY",
            authDomain: "inventario-francisco-castilho.firebaseapp.com",
            projectId: "inventario-francisco-castilho",
            storageBucket: "inventario-francisco-castilho.firebasestorage.app",
            messagingSenderId: "193527551224",
            appId: "1:193527551224:web:e4b6469382251bbf3f570d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let inventory = [];
        let userRole = 'visitor'; 
        
        let pendingItems = [];
        let itemsToDelete = [];
        let currentMode = null; 
        let editingIndexOrId = null;

        // --- CONFIGURA√á√ÉO DAS OP√á√ïES DIN√ÇMICAS (SINCRONIZADO NO FIREBASE) ---
        let configData = {
            types: ["Reagente", "Vidraria", "Equipamento"],
            locations: ["Prateleira A", "Prateleira B", "Geladeira", "Arm√°rio 1", "Arm√°rio 2"],
            units: ["mL", "L", "g", "kg", "Unid", "Caixa", "Frasco"]
        };

        async function loadConfigFromFirebase() {
            try {
                const docRef = doc(db, "inventario", "--CONFIGURACOES--");
                const snap = await getDoc(docRef);
                if(snap.exists()) {
                    const data = snap.data();
                    configData.types = data.types || configData.types;
                    configData.locations = data.locations || configData.locations;
                    configData.units = data.units || configData.units;
                } else {
                    await setDoc(docRef, { ...configData, nome: "___CONFIG___" });
                }
                populateAllSelects();
            } catch(e) { 
                console.error("Usando dados padr√µes, erro ao ler config:", e); 
                populateAllSelects();
            }
        }

        async function saveConfig() {
            try {
                await setDoc(doc(db, "inventario", "--CONFIGURACOES--"), {
                    nome: "___CONFIG___",
                    types: configData.types,
                    locations: configData.locations,
                    units: configData.units
                });
                populateAllSelects();
            } catch(e) {
                console.error(e);
                alert("Erro ao sincronizar op√ß√µes. Voc√™ tem permiss√£o de Admin?");
            }
        }

        function populateAllSelects() {
            const fill = (id, arr) => {
                const el = document.getElementById(id);
                if(!el || !arr) return;
                const currentVal = el.value;
                el.innerHTML = arr.map(op => `<option value="${op}">${op}</option>`).join('');
                if(arr.includes(currentVal)) el.value = currentVal;
            }
            fill('tipo', configData.types);
            fill('local', configData.locations);
            fill('unidade', configData.units);
            
            const f = document.getElementById('filterType');
            if(f && configData.types) {
                const currFilter = f.value;
                f.innerHTML = '<option value="Todos">Todos os Tipos</option>' + configData.types.map(t => `<option value="${t}">${t}</option>`).join('');
                f.value = currFilter || 'Todos';
            }
        }

        window.manageOption = async function(category, action) {
            let arr; let elId;
            if(category === 'type') { arr = configData.types; elId = 'tipo'; }
            else if(category === 'loc') { arr = configData.locations; elId = 'local'; }
            else { arr = configData.units; elId = 'unidade'; }
            
            const el = document.getElementById(elId);

            if(action === 'add') {
                const val = prompt("Nova op√ß√£o:");
                if(val && val.trim()) { 
                    arr.push(val.trim()); 
                    await saveConfig(); 
                    el.value = val.trim(); 
                }
            } else if(action === 'edit') {
                if(!el.value) return;
                const val = prompt("Editar:", el.value);
                if(val && val.trim()) {
                    const idx = arr.indexOf(el.value);
                    if(idx !== -1) arr[idx] = val.trim();
                    await saveConfig();
                }
            } else {
                if(!el.value) return;
                if(confirm("Remover op√ß√£o?")) {
                    const idx = arr.indexOf(el.value);
                    if(idx !== -1) arr.splice(idx, 1);
                    await saveConfig();
                }
            }
        }

        // --- SISTEMA DE LOGIN E PERMISS√ÉO ---
        onAuthStateChanged(auth, async (user) => {
            const container = document.getElementById('authContainer');
            if (user) {
                try {
                    const userRef = doc(db, "usuarios", user.email);
                    const snap = await getDoc(userRef);
                    if (snap.exists()) {
                        userRole = snap.data().role;
                    } else {
                        if(confirm("Deseja solicitar acesso de Admin?")) {
                            await setDoc(userRef, { email: user.email, name: user.displayName, role: 'pending' });
                            alert("Solicitado. Aguarde libera√ß√£o.");
                            userRole = 'pending';
                        } else userRole = 'visitor';
                    }
                } catch(e) { console.error(e); userRole = 'visitor'; }

                const adminBtn = userRole === 'super_admin' ? `<button type="button" class="btn-config" onclick="openAdmin()">‚öô</button>` : '';
                container.innerHTML = `
                    <div class="user-chip">
                        <img src="${user.photoURL}" class="avatar">
                        <div class="user-details">
                            <span class="u-name">${user.displayName.split(' ')[0]}</span>
                            <span class="u-role">Status: ${userRole}</span>
                        </div>
                        ${adminBtn}
                        <button type="button" class="btn-logout" onclick="logout()">Sair</button>
                    </div>`;
            } else {
                userRole = 'visitor';
                container.innerHTML = `
                    <button type="button" class="btn-google" onclick="loginGoogle()">
                        <svg class="google-icon" viewBox="0 0 48 48"><path fill="#EA4335" d="M24 9.5c3.54 0 6.71 1.22 9.21 3.6l6.85-6.85C35.9 2.38 30.47 0 24 0 14.62 0 6.51 5.38 2.56 13.22l7.98 6.19C12.43 13.72 17.74 9.5 24 9.5z"></path><path fill="#4285F4" d="M46.98 24.55c0-1.57-.15-3.09-.38-4.55H24v9.02h12.94c-.58 2.96-2.26 5.48-4.78 7.18l7.73 6c4.51-4.18 7.09-10.36 7.09-17.65z"></path><path fill="#FBBC05" d="M10.53 28.59c-.48-1.45-.76-2.99-.76-4.59s.27-3.14.76-4.59l-7.98-6.19C.92 16.46 0 20.12 0 24c0 3.88.92 7.54 2.56 10.78l7.97-6.19z"></path><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.81l-7.73-6c-2.15 1.45-4.92 2.3-8.16 2.3-6.26 0-11.57-4.22-13.47-9.91l-7.98 6.19C6.51 42.62 14.62 48 24 48z"></path></svg>
                        Entrar com Google
                    </button>`;
            }
            updateInterface();
            loadInventory();
        });

        function updateInterface() {
            const isAdmin = (userRole === 'admin' || userRole === 'super_admin');
            document.getElementById('btnImport').style.display = isAdmin ? 'inline-flex' : 'none';
            document.getElementById('btnBackup').style.display = isAdmin ? 'inline-flex' : 'none';
            document.getElementById('btnEditInventory').style.display = isAdmin ? 'inline-flex' : 'none';
            document.getElementById('colActions').style.display = isAdmin ? 'table-cell' : 'none';
            applyFilters();
        }

        // INIT: Carrega Configura√ß√µes primeiro, depois a Tabela
        loadConfigFromFirebase().then(() => loadInventory());

        async function loadInventory() {
            try {
                const q = query(collection(db, "inventario"), orderBy("nome"));
                const snap = await getDocs(q);
                inventory = [];
                snap.forEach(d => {
                    if(d.id !== '--CONFIGURACOES--') {
                        inventory.push({ id: d.id, ...d.data() });
                    }
                });
                applyFilters();
                document.getElementById('statusMsg').innerText = `${inventory.length} itens carregados.`;
            } catch (e) { console.error(e); }
        }

        window.applyFilters = () => {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;
            const filtered = inventory.filter(i => {
                const matchesTerm = i.nome.toLowerCase().includes(term) || (i.localizacao||'').toLowerCase().includes(term);
                const matchesType = typeFilter === 'Todos' || i.tipo === typeFilter;
                return matchesTerm && matchesType;
            });
            renderTable(filtered);
        }

        function renderTable(list) {
            const tbody = document.getElementById('inventoryTable');
            const isAdmin = (userRole === 'admin' || userRole === 'super_admin');
            
            if(list.length === 0) { tbody.innerHTML = `<tr><td colspan="6" style="text-align:center; padding:2rem;">Nada encontrado.</td></tr>`; return; }

            tbody.innerHTML = list.map(item => {
                let badgeClass = 'badge-med';
                if((item.status||'').includes('Alto')) badgeClass = 'badge-alto';
                if((item.status||'').includes('Cr√≠t')) badgeClass = 'badge-low';

                const actionCell = isAdmin ? `
                    <td class="action-td">
                        <div class="action-buttons">
                            <button type="button" class="btn-icon" onclick="window.editDirect('${item.id}')" title="Editar R√°pido">‚úé</button>
                            <button type="button" class="btn-icon delete" onclick="window.deleteDirect('${item.id}')" title="Excluir">‚úï</button>
                        </div>
                    </td>` : ``;

                return `<tr>
                    <td><span class="badge badge-type">${item.tipo}</span></td>
                    <td>${item.localizacao || '-'}</td>
                    <td><strong>${item.nome}</strong></td>
                    <td>${item.quantidade} <small>${item.unidade}</small></td>
                    <td><span class="badge ${badgeClass}">${item.status}</span></td>
                    ${actionCell}
                </tr>`;
            }).join('');
        }

        // --- L√ìGICA DO MENU LOTE (MODAL) ---
        window.openManagementModal = function() {
            document.getElementById('managementModal').classList.add('active');
            window.switchTab('add');
        }

        window.switchTab = function(tabName) {
            document.getElementById('tab-add').style.display = 'none';
            document.getElementById('tab-remove').style.display = 'none';
            document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
            document.getElementById(`tab-${tabName}`).style.display = 'block';
            
            const btns = document.querySelectorAll('.tab-btn');
            if(tabName === 'add') btns[0].classList.add('active');
            else {
                btns[1].classList.add('active');
                renderDeleteList();
            }
        }

        window.openStagingItemForm = function() {
            currentMode = 'staging_new';
            openItemFormGeneric();
        }

        window.editStagingItem = function(index) {
            currentMode = 'staging_edit';
            editingIndexOrId = index;
            openItemFormGeneric(pendingItems[index]);
        }

        window.clearStaging = function() {
            pendingItems = [];
            renderStagingList();
        }

        window.removeStagingItem = function(index) {
            pendingItems.splice(index, 1);
            renderStagingList();
        }

        function renderStagingList() {
            const container = document.getElementById('stagingArea');
            if (pendingItems.length === 0) {
                container.innerHTML = `<div style="text-align: center; color: var(--text-light); padding: 2rem;">A lista de adi√ß√£o est√° vazia.</div>`;
                return;
            }
            container.innerHTML = pendingItems.map((item, index) => `
                <div class="staging-item">
                    <div class="staging-info">
                        <h4>${item.nome}</h4>
                        <span>${item.tipo} ‚Ä¢ ${item.quantidade} ${item.unidade}</span>
                    </div>
                    <div style="display:flex; gap:0.5rem;">
                        <button type="button" class="btn-icon" onclick="editStagingItem(${index})" title="Editar" style="background:var(--input-bg); border:1px solid var(--border);">‚úé</button>
                        <button type="button" class="btn-icon delete" onclick="removeStagingItem(${index})" title="Remover" style="background:#fff5f5; border:1px solid #fed7d7;">‚úï</button>
                    </div>
                </div>
            `).join('');
        }

        window.commitStagedItems = async function() {
            if (pendingItems.length === 0) return alert("Lista vazia.");
            const batch = writeBatch(db);
            pendingItems.forEach(item => {
                const docRef = doc(collection(db, "inventario"));
                batch.set(docRef, { ...item, updatedAt: Timestamp.now() });
            });
            try {
                await batch.commit();
                alert(`${pendingItems.length} itens gravados!`);
                pendingItems = [];
                renderStagingList();
                loadInventory();
                window.closeModal('managementModal');
            } catch (e) { alert("Erro: " + e.message); }
        }

        // CORRE√á√ÉO DO ALINHAMENTO DO TEXTO NA LISTA DE EXCLUS√ÉO
        window.renderDeleteList = function() {
            const term = document.getElementById('deleteSearch').value.toLowerCase();
            const container = document.getElementById('deleteListArea');
            const filtered = inventory.filter(i => i.nome.toLowerCase().includes(term));

            container.innerHTML = filtered.map(item => `
                <label class="staging-item" style="cursor:pointer; display:flex; justify-content:flex-start; align-items:center;">
                    <input type="checkbox" value="${item.id}" name="deleteItem" style="margin-right:15px; width:18px; height:18px;">
                    <div class="staging-info" style="text-align: left; flex: 1;">
                        <h4>${item.nome}</h4>
                        <span>${item.localizacao}</span>
                    </div>
                </label>
            `).join('');
        }

        window.confirmBatchDelete = function() {
            const checkboxes = document.querySelectorAll('input[name="deleteItem"]:checked');
            if (checkboxes.length === 0) return alert("Selecione itens.");
            itemsToDelete = Array.from(checkboxes).map(cb => cb.value);
            document.getElementById('confirmDeleteModal').classList.add('active');
        }

        window.executeBatchDelete = async function() {
            const batch = writeBatch(db);
            itemsToDelete.forEach(id => batch.delete(doc(db, "inventario", id)));
            try {
                await batch.commit();
                window.closeModal('confirmDeleteModal');
                window.closeModal('managementModal');
                loadInventory();
                alert("Itens exclu√≠dos.");
            } catch (e) { alert("Erro: " + e.message); }
        }

        window.editDirect = function(id) {
            currentMode = 'direct_edit';
            editingIndexOrId = id;
            const item = inventory.find(i => i.id === id);
            openItemFormGeneric(item);
        }

        window.deleteDirect = async function(id) {
            if(confirm("Excluir este item?")) {
                await deleteDoc(doc(db, "inventario", id));
                loadInventory();
            }
        }

        function openItemFormGeneric(item = null) {
            try {
                document.getElementById('itemForm').reset();
                const title = document.getElementById('modalTitle');
                
                if(currentMode === 'staging_new') title.innerText = "Adicionar √† Lista";
                else title.innerText = "Editar Item";
                
                // INJE√á√ÉO AUTOM√ÅTICA
                if (item) {
                    let changed = false;
                    if (item.unidade && !configData.units.includes(item.unidade)) { configData.units.push(item.unidade); changed = true; }
                    if (item.tipo && !configData.types.includes(item.tipo)) { configData.types.push(item.tipo); changed = true; }
                    if (item.localizacao && !configData.locations.includes(item.localizacao)) { configData.locations.push(item.localizacao); changed = true; }
                    if (changed) saveConfig();
                }

                populateAllSelects();

                if (item) {
                    document.getElementById('nome').value = item.nome || '';
                    document.getElementById('tipo').value = item.tipo || '';
                    document.getElementById('qtd').value = item.quantidade || '';
                    document.getElementById('unidade').value = item.unidade || '';
                    document.getElementById('local').value = item.localizacao || '';
                    document.getElementById('status').value = item.status || 'Satisfat√≥rio';
                }
                document.getElementById('itemModal').classList.add('active');
            } catch (err) {
                console.error("Erro no formul√°rio:", err);
            }
        }

        document.getElementById('itemForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const newItem = {
                nome: document.getElementById('nome').value,
                tipo: document.getElementById('tipo').value,
                quantidade: document.getElementById('qtd').value,
                unidade: document.getElementById('unidade').value,
                localizacao: document.getElementById('local').value,
                status: document.getElementById('status').value,
            };

            if (currentMode === 'staging_new') {
                pendingItems.push(newItem);
                renderStagingList();
                window.closeModal('itemModal');
            } else if (currentMode === 'staging_edit') {
                pendingItems[editingIndexOrId] = newItem;
                renderStagingList();
                window.closeModal('itemModal');
            } else if (currentMode === 'direct_edit') {
                try {
                    await updateDoc(doc(db, "inventario", editingIndexOrId), { ...newItem, updatedAt: Timestamp.now() });
                    window.closeModal('itemModal');
                    loadInventory();
                } catch(err) { alert("Erro: " + err.message); }
            }
        });

        window.closeModal = (id) => document.getElementById(id).classList.remove('active');
        window.loginGoogle = () => signInWithPopup(auth, new GoogleAuthProvider());
        
        window.logout = async () => {
            userRole = 'visitor'; 
            updateInterface();    
            document.getElementById('authContainer').innerHTML = '<span style="color:var(--text-light); font-size:0.8rem;">Saindo...</span>';
            await signOut(auth);  
            window.location.reload(); 
        };

        window.openAdmin = async () => {
            if(userRole !== 'super_admin') return;
            document.getElementById('adminModal').classList.add('active');
            const snap = await getDocs(collection(db, "usuarios"));
            const list = document.getElementById('usersList');
            list.innerHTML = "";
            snap.forEach(d => {
                const u = d.data();
                if(d.id === auth.currentUser.email) return;
                const btn = u.role === 'pending' 
                    ? `<button type="button" onclick="window.setUserRole('${d.id}', 'admin')" style="background:green;color:white;border:none;padding:5px;cursor:pointer;">Aprovar</button>`
                    : `<button type="button" onclick="window.setUserRole('${d.id}', 'visitor')" style="background:red;color:white;border:none;padding:5px;cursor:pointer;">Remover</button>`;
                list.innerHTML += `<div style="display:flex;justify-content:space-between;margin-bottom:10px;padding:10px;background:#f8fafc;"><div><b>${u.name}</b><br><small>${u.email}</small></div>${btn}</div>`;
            });
        };
        window.setUserRole = async (email, role) => {
             if(role === 'visitor') await deleteDoc(doc(db, "usuarios", email));
             else await updateDoc(doc(db, "usuarios", email), { role });
             window.openAdmin();
        };

        window.exportBackup = function() {
            let csv = "Tipo,Localiza√ß√£o,Nome,Quantidade,Unidade,Status\n";
            inventory.forEach(i => csv += `"${i.tipo}","${i.localizacao}","${i.nome}","${i.quantidade}","${i.unidade}","${i.status}"\n`);
            const a = document.createElement("a");
            a.href = URL.createObjectURL(new Blob([csv],{type:'text/csv;charset=utf-8;'})); 
            a.download = "backup.csv"; a.click();
        }
        window.importData = () => document.getElementById('fileInput').click();
        window.handleFileUpload = (e) => {
            const f = e.target.files[0];
            if(!f) return;
            const r = new FileReader();
            r.onload = async (evt) => {
                const lines = evt.target.result.split('\n');
                if(confirm(`Importar ${lines.length} linhas?`)) {
                    for(let i=1; i<lines.length; i++) {
                        const p = lines[i].split(',').map(s=>s.replace(/"/g,''));
                        if(p.length>=5) await addDoc(collection(db,"inventario"), {tipo:p[0], localizacao:p[1], nome:p[2], quantidade:p[3], unidade:p[4], status:p[5], updatedAt:Timestamp.now()});
                    }
                    loadInventory();
                }
            };
            r.readAsText(f);
        };

        document.getElementById('searchInput').addEventListener('input', applyFilters);
        document.getElementById('filterType').addEventListener('change', applyFilters);
    </script>
</body>
</html>
