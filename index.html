<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Inventário Laboratório E.E Bairro Francisco Castilho</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:wght@400;700&family=Work+Sans:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- ESTILOS GERAIS (Design Polido) --- */
        :root {
            --primary: #006989; --primary-dark: #004d66; --accent: #00b4d8;
            --bg-body: #f0f4f8; --surface: #ffffff; --input-bg: #f8fafc;
            --text-main: #2d3748; --text-light: #718096; --border: #e2e8f0;
            --success: #48bb78; --warning: #ed8936; --danger: #ef4444;
            --radius-lg: 20px; --radius-md: 12px;
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        body { font-family: 'Work Sans', sans-serif; background: var(--bg-body); color: var(--text-main); line-height: 1.6; min-height: 100vh; padding-bottom: 60px; }

        /* HEADER */
        .header { background: var(--surface); padding: 1.5rem 0; box-shadow: var(--shadow-sm); border-bottom-left-radius: 30px; border-bottom-right-radius: 30px; margin-bottom: 2rem; position: relative; z-index: 10; }
        .container { max-width: 1400px; margin: 0 auto; padding: 0 1.5rem; }
        .header-content { display: flex; align-items: center; justify-content: center; flex-direction: column; text-align: center; gap: 1rem; }
        .logo-img { max-height: 100px; width: auto; object-fit: contain; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1)); }
        .logo-text h1 { font-family: 'Space Mono', monospace; font-size: 1.25rem; font-weight: 700; color: var(--primary); line-height: 1.2; margin-bottom: 0.25rem; }
        .logo-text p { color: var(--text-light); font-size: 0.85rem; font-weight: 500; }
        .last-update { display: inline-block; margin-top: 0.5rem; font-size: 0.75rem; color: var(--text-light); background: var(--input-bg); padding: 0.25rem 0.75rem; border-radius: 20px; border: 1px solid var(--border); font-weight: 600; }
        
        @media (min-width: 768px) {
            .header-content { flex-direction: row; text-align: left; justify-content: flex-start; gap: 2rem; }
            .logo-text h1 { font-size: 2rem; } .logo-text p { font-size: 1rem; } .logo-img { max-height: 120px; }
        }

        /* PAINEL DE CONTROLE */
        .dashboard-card { background: var(--surface); border-radius: var(--radius-lg); padding: 1.5rem; box-shadow: var(--shadow-lg); margin-bottom: 2rem; border: 1px solid var(--border); }
        
        .top-actions { display: flex; justify-content: flex-end; align-items: center; gap: 1.5rem; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border); padding-bottom: 1rem; flex-wrap: wrap; }
        
        .btn-link { background: none; border: none; cursor: pointer; color: var(--text-light); font-size: 0.85rem; font-weight: 600; transition: color 0.2s; display: flex; align-items: center; gap: 0.5rem; }
        .btn-link:hover { color: var(--primary); }
        .btn-link.backup { color: var(--success); }
        .btn-link.backup:hover { color: #2f855a; }

        .controls-wrapper { display: flex; flex-direction: column; gap: 1rem; }
        .search-group { display: flex; gap: 1rem; flex-direction: column; width: 100%; }
        .input-wrapper { position: relative; width: 100%; }
        
        .search-input, .filter-select { width: 100%; padding: 0.85rem 1rem 0.85rem 2.8rem; font-size: 1rem; border: 1px solid var(--border); background: var(--input-bg); border-radius: var(--radius-md); font-family: inherit; transition: all 0.3s ease; color: var(--text-main); appearance: none; }
        .filter-select { padding-left: 1rem; }
        .search-input:focus, .filter-select:focus { outline: none; border-color: var(--accent); background: var(--surface); box-shadow: 0 0 0 4px rgba(0, 180, 216, 0.15); }
        .search-icon { position: absolute; left: 1rem; top: 50%; transform: translateY(-50%); color: var(--text-light); pointer-events: none; }

        .btn-primary { width: 100%; padding: 0.85rem 1.5rem; border: none; border-radius: var(--radius-md); font-weight: 600; font-size: 0.95rem; cursor: pointer; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; background: var(--primary); color: white; box-shadow: 0 4px 6px rgba(0, 105, 137, 0.2); }
        .btn-primary:active { transform: scale(0.98); } .btn-primary:hover { background: var(--primary-dark); }
        
        .btn-secondary { padding: 0.85rem 1.5rem; border: 1px solid var(--border); border-radius: var(--radius-md); font-weight: 600; background: white; color: var(--text-main); cursor: pointer; transition: all 0.2s; }

        @media (min-width: 768px) {
            .controls-wrapper { flex-direction: row; }
            .search-group { flex-direction: row; flex: 1; }
            .btn-primary { width: auto; min-width: 180px; }
        }

        /* AVISO E TABELA */
        .warning-box { background: #fffaf0; border-left: 4px solid var(--warning); padding: 1.25rem; border-radius: var(--radius-md); margin-bottom: 2rem; color: #9c4221; font-size: 0.9rem; box-shadow: var(--shadow-sm); }
        .warning-title { font-weight: 700; display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; color: #c05621; }

        .table-wrapper { background: var(--surface); border-radius: var(--radius-lg); box-shadow: var(--shadow-lg); overflow: hidden; border: 1px solid var(--border); }
        .table-header { padding: 1.25rem; background: white; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .stats { background: var(--bg-body); padding: 0.35rem 0.85rem; border-radius: 50px; font-size: 0.8rem; color: var(--primary); font-weight: 700; }
        
        .table-responsive { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        table { width: 100%; border-collapse: collapse; min-width: 800px; }
        th { background: #f8fafc; color: var(--text-light); font-weight: 700; text-transform: uppercase; font-size: 0.75rem; letter-spacing: 0.05em; padding: 1rem; text-align: left; border-bottom: 2px solid var(--border); white-space: nowrap; }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); font-size: 0.9rem; vertical-align: middle; }
        tr:last-child td { border-bottom: none; } tbody tr:hover { background-color: #fcfcfc; }

        .badge { display: inline-block; padding: 0.25rem 0.75rem; border-radius: 50px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; letter-spacing: 0.03em; white-space: nowrap; }
        .badge-type { background: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .badge-alto { background: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        .badge-satisfatorio { background: #ffedd5; color: #c2410c; border: 1px solid #fed7aa; }
        .badge-critico { background: #fee2e2; color: #b91c1c; border: 1px solid #fecaca; }
        .badge-default { background: #f1f5f9; color: #475569; }
        .quantidade { font-family: 'Space Mono', monospace; font-weight: 700; color: var(--text-main); }

        .action-buttons { display: flex; gap: 0.75rem; }
        .btn-icon { width: 36px; height: 36px; border-radius: 10px; border: 1px solid transparent; background: transparent; color: var(--text-light); cursor: pointer; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-icon:hover { background: var(--bg-body); color: var(--primary); border-color: var(--border); }
        .btn-icon.delete:hover { background: #fff5f5; color: var(--danger); border-color: #fed7d7; }

        /* MODAL */
        .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(15, 23, 42, 0.7); backdrop-filter: blur(5px); z-index: 1000; padding: 1rem; align-items: center; justify-content: center; opacity: 0; transition: opacity 0.3s ease; }
        .modal.active { display: flex; opacity: 1; }
        .modal-content { background: var(--surface); padding: 2rem; border-radius: var(--radius-lg); width: 100%; max-width: 500px; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); transform: scale(0.95); transition: transform 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
        .modal.active .modal-content { transform: scale(1); }
        .modal-header { margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-size: 1.25rem; font-weight: 700; color: var(--primary); }
        .btn-close-modal { background: var(--input-bg); border: none; cursor: pointer; color: var(--text-light); width: 32px; height: 32px; border-radius: 50%; display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-close-modal:hover { background: #e2e8f0; color: var(--danger); }

        .form-grid { display: grid; gap: 1.25rem; }
        .form-row { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; }
        .form-label { display: block; margin-bottom: 0.5rem; font-weight: 700; font-size: 0.7rem; color: var(--text-light); text-transform: uppercase; letter-spacing: 0.05em; }
        .form-input, .form-select { width: 100%; padding: 0.85rem; border: 1px solid var(--border); border-radius: 10px; font-family: inherit; font-size: 0.95rem; background: var(--input-bg); color: var(--text-main); transition: all 0.2s; }
        .form-input:focus, .form-select:focus { border-color: var(--accent); background: var(--surface); box-shadow: 0 0 0 3px rgba(0, 180, 216, 0.1); outline: none; }
        .dynamic-control-group { display: flex; gap: 0.5rem; align-items: stretch; } .dynamic-control-group select { flex: 1; }
        .tools-wrapper { display: flex; background: var(--input-bg); border: 1px solid var(--border); border-radius: 10px; padding: 2px; gap: 2px; }
        .btn-mini { width: 38px; background: transparent; border: none; border-radius: 8px; cursor: pointer; color: var(--text-light); display: flex; align-items: center; justify-content: center; transition: all 0.2s; }
        .btn-mini:hover { background: #e0f2fe; color: var(--primary); } .btn-mini.danger:hover { background: #fee2e2; color: var(--danger); }
        .form-actions { display: grid; grid-template-columns: 1fr 1fr; gap: 1rem; margin-top: 2rem; border-top: 1px solid var(--border); padding-top: 1.5rem; }
        @media (max-width: 600px) { .form-row { grid-template-columns: 1fr; } .form-actions { grid-template-columns: 1fr; } .btn-secondary { order: 2; } .btn-primary { order: 1; } }

        /* PRINT */
        @media print {
            body { background: white; padding: 0; color: black; }
            .header { box-shadow: none; margin: 0; padding: 1rem 0; border-radius: 0; }
            .search-section, .btn-primary, .btn-secondary, .btn-icon, .warning-box, .action-buttons, .tools-wrapper { display: none !important; }
            th:last-child, td:last-child { display: none; }
            .table-wrapper { border: 1px solid #000; box-shadow: none; border-radius: 0; }
            table { width: 100%; min-width: 100%; }
            th, td { border: 1px solid #ccc; padding: 0.5rem; font-size: 10pt; color: black; }
            .badge { border: 1px solid #000; background: none !important; color: black !important; padding: 0; }
            .container { max-width: 100%; padding: 0; margin: 0; }
            .logo-img { max-height: 60px; }
        }
    </style>
</head>
<body>

    <header class="header">
        <div class="container">
            <div class="header-content">
                <img src="logo.png" alt="Logo Francisco Castilho" class="logo-img" onerror="this.style.display='none'">
                <div class="logo-text">
                    <h1>Inventário Laboratório<br>E.E Bairro Francisco Castilho</h1>
                    <p>Gestão Inteligente de Materiais e Reagentes</p>
                    <span id="lastUpdate" class="last-update">A carregar dados...</span>
                </div>
            </div>
        </div>
    </header>

    <main class="container">
        <div class="dashboard-card search-section">
            <div class="top-actions">
                <button class="btn-link backup" onclick="exportBackup()" title="Baixar todos os dados em CSV">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="7 10 12 15 17 10"></polyline><line x1="12" y1="15" x2="12" y2="3"></line></svg>
                    Baixar Backup
                </button>
                
                <button class="btn-link" onclick="importData()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path><polyline points="17 8 12 3 7 8"></polyline><line x1="12" y1="3" x2="12" y2="15"></line></svg>
                    Importar / Restaurar
                </button>
                
                <button class="btn-link" onclick="window.print()">
                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 6 2 18 2 18 9"></polyline><path d="M6 18H4a2 2 0 0 1-2-2v-5a2 2 0 0 1 2-2h16a2 2 0 0 1 2 2v5a2 2 0 0 1-2 2h-2"></path><rect x="6" y="14" width="12" height="8"></rect></svg>
                    Imprimir
                </button>
            </div>

            <div class="controls-wrapper">
                <div class="search-group">
                    <div class="input-wrapper">
                        <svg class="search-icon" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"></circle><path d="m21 21-4.35-4.35"></path></svg>
                        <input type="text" id="searchInput" class="search-input" placeholder="Buscar item, local ou código...">
                    </div>
                    <div style="min-width: 200px;">
                        <select id="filterType" class="filter-select" onchange="applyFilters()">
                            <option value="Todos">Todos os Tipos</option>
                        </select>
                    </div>
                </div>
                <button type="button" class="btn-primary" onclick="openModal()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    Novo Item
                </button>
            </div>
        </div>

        <div class="warning-box">
            <span class="warning-title">
                <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path><line x1="12" y1="9" x2="12" y2="13"></line><line x1="12" y1="17" x2="12.01" y2="17"></line></svg>
                Política de Quantidade
            </span>
            <p><strong>Quantidade</strong> = Capacidade do frasco. <strong>Status</strong> = Disponibilidade real:</p>
            <ul style="margin-left: 1.2rem; margin-top: 0.5rem; font-size: 0.85rem;">
                <li><strong>Alto:</strong> Cheio ou quase cheio.</li>
                <li><strong>Satisfatório:</strong> Pela metade.</li>
                <li><strong>Crítico!:</strong> Quase vazio.</li>
            </ul>
        </div>

        <div class="table-wrapper">
            <div class="table-header">
                <h2 style="font-size: 1.25rem; color: var(--primary);">Inventário Completo</h2>
                <span class="stats" id="totalItems">0 Itens</span>
            </div>
            <div class="table-responsive">
                <table>
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Localização</th>
                            <th>Item / Reagente</th>
                            <th>Quantidade</th>
                            <th>Unidade</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                    </thead>
                    <tbody id="inventoryTable"></tbody>
                </table>
            </div>
        </div>
    </main>

    <div id="modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="modalTitle">Novo Item</h2>
                <button type="button" class="btn-close-modal" onclick="closeModal()">✕</button>
            </div>
            
            <form id="itemForm" onsubmit="saveItem(event)" class="form-grid">
                
                <div class="form-group">
                    <label class="form-label">Tipo do Material <span style="color:var(--danger)">*</span></label>
                    <div class="dynamic-control-group">
                        <select id="tipo" class="form-select" required></select>
                        <div class="tools-wrapper">
                            <button type="button" class="btn-mini" onclick="manageOption('type', 'add')" title="Adicionar">+</button>
                            <button type="button" class="btn-mini" onclick="manageOption('type', 'edit')" title="Editar">✎</button>
                            <button type="button" class="btn-mini danger" onclick="manageOption('type', 'remove')" title="Remover">✕</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Nome do Item <span style="color:var(--danger)">*</span></label>
                    <input type="text" id="nome" class="form-input" required placeholder="Ex: Ácido Sulfúrico...">
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Quantidade <span style="color:var(--danger)">*</span></label>
                        <input type="number" id="quantidade" class="form-input" min="0" required placeholder="0">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Unidade <span style="color:var(--danger)">*</span></label>
                        <select id="unidade" class="form-select" required>
                            <option value="">Selecione...</option>
                            <option value="mL">mL</option>
                            <option value="L">L</option>
                            <option value="g">g</option>
                            <option value="kg">kg</option>
                            <option value="mg">mg</option>
                            <option value="unidade">Unidade</option>
                            <option value="caixa">Caixa</option>
                            <option value="frasco">Frasco</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Localização <span style="color:var(--danger)">*</span></label>
                    <div class="dynamic-control-group">
                        <select id="localizacao" class="form-select" required></select>
                        <div class="tools-wrapper">
                            <button type="button" class="btn-mini" onclick="manageOption('loc', 'add')" title="Adicionar">+</button>
                            <button type="button" class="btn-mini" onclick="manageOption('loc', 'edit')" title="Editar">✎</button>
                            <button type="button" class="btn-mini danger" onclick="manageOption('loc', 'remove')" title="Remover">✕</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Status Real <span style="color:var(--danger)">*</span></label>
                    <div class="dynamic-control-group">
                        <select id="statusManual" class="form-select" required></select>
                        <div class="tools-wrapper">
                            <button type="button" class="btn-mini" onclick="manageOption('status', 'add')" title="Adicionar">+</button>
                            <button type="button" class="btn-mini" onclick="manageOption('status', 'edit')" title="Editar">✎</button>
                            <button type="button" class="btn-mini danger" onclick="manageOption('status', 'remove')" title="Remover">✕</button>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn-secondary" onclick="closeModal()">Cancelar</button>
                    <button type="submit" class="btn-primary">Salvar no Sistema</button>
                </div>
            </form>
        </div>
    </div>

    <input type="file" id="fileInput" accept=".csv" style="display: none;" onchange="handleFileUpload(event)">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc, Timestamp, query, orderBy } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

        // --- SUAS CREDENCIAIS ---
        const firebaseConfig = {
            apiKey: "AIzaSyC3QfyB6u3MUbAsDry4W6cMDDdLHxFEWHY",
            authDomain: "inventario-francisco-castilho.firebaseapp.com",
            projectId: "inventario-francisco-castilho",
            storageBucket: "inventario-francisco-castilho.firebasestorage.app",
            messagingSenderId: "193527551224",
            appId: "1:193527551224:web:e4b6469382251bbf3f570d"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const invCollection = collection(db, "inventario");

        let inventory = [];
        let editingId = null;
        
        let configData = {
            types: ["Reagente", "Vidraria", "Equipamento"],
            locations: ["Prateleira A", "Prateleira B", "Geladeira", "Armário 1", "Armário 2"],
            statuses: ["Alto", "Satisfatório", "Crítico!"]
        };

        window.addEventListener('load', async () => {
            loadConfigLocal();
            await loadDataFromFirebase();
            populateAllSelects();
        });

        // --- BACKUP / EXPORTAÇÃO ---
        window.exportBackup = function() {
            if (inventory.length === 0) return alert("Nada para exportar.");
            
            let csvContent = "Tipo,Localização,Nome,Quantidade,Unidade,Status\n";
            
            inventory.forEach(item => {
                const safe = (text) => text ? `"${text.toString().replace(/"/g, '""')}"` : '""';
                const row = [
                    safe(item.tipo), safe(item.localizacao), safe(item.nome),
                    safe(item.quantidade), safe(item.unidade), safe(item.status)
                ].join(",");
                csvContent += row + "\n";
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `inventario_backup_${new Date().toISOString().slice(0,10)}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // --- FIREBASE ---
        async function loadDataFromFirebase() {
            try {
                document.getElementById('lastUpdate').textContent = "Sincronizando...";
                const q = query(invCollection, orderBy("nome"));
                const querySnapshot = await getDocs(q);
                
                inventory = [];
                let latestTimestamp = 0;

                querySnapshot.forEach((doc) => {
                    const data = doc.data();
                    if(data) {
                        inventory.push({ id: doc.id, ...data });
                        if (data.updatedAt && data.updatedAt.seconds > latestTimestamp) {
                            latestTimestamp = data.updatedAt.seconds;
                        }
                    }
                });

                applyFilters();
                
                if (latestTimestamp > 0) {
                    const dateObj = new Date(latestTimestamp * 1000);
                    const dateStr = dateObj.toLocaleString('pt-BR', { day: '2-digit', month: '2-digit', hour: '2-digit', minute: '2-digit' });
                    document.getElementById('lastUpdate').textContent = `Última atualização: ${dateStr}`;
                } else {
                    document.getElementById('lastUpdate').textContent = "Sistema pronto";
                }

            } catch (error) {
                console.error(error);
                document.getElementById('lastUpdate').textContent = "Erro de conexão";
            }
        }

        window.saveItem = async function(e) {
            e.preventDefault();
            const btn = document.querySelector('#itemForm button[type="submit"]');
            const originalText = btn.textContent;
            btn.textContent = "A salvar...";
            btn.disabled = true;

            const itemData = {
                tipo: document.getElementById('tipo').value,
                nome: document.getElementById('nome').value.trim(),
                quantidade: document.getElementById('quantidade').value,
                unidade: document.getElementById('unidade').value,
                localizacao: document.getElementById('localizacao').value,
                status: document.getElementById('statusManual').value,
                updatedAt: Timestamp.now()
            };

            try {
                if (editingId) {
                    await updateDoc(doc(db, "inventario", editingId), itemData);
                } else {
                    await addDoc(invCollection, itemData);
                }
                closeModal();
                await loadDataFromFirebase();
            } catch (error) {
                alert("Erro ao salvar: " + error.message);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        window.deleteItemById = async function(id) {
            if (confirm('Tem a certeza que deseja eliminar este item permanentemente?')) {
                try {
                    await deleteDoc(doc(db, "inventario", id));
                    await loadDataFromFirebase();
                } catch (error) {
                    alert("Erro ao eliminar: " + error.message);
                }
            }
        }

        // --- IMPORTAÇÃO ---
        window.importData = function() { document.getElementById('fileInput').click(); }
        
        window.handleFileUpload = function(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = async function(e) {
                const text = e.target.result;
                const lines = text.split('\n');
                let count = 0;

                if (confirm(`Deseja importar os dados do ficheiro "${file.name}" para o banco de dados online?`)) {
                    document.getElementById('lastUpdate').textContent = "A importar...";
                    for (let i = 1; i < lines.length; i++) {
                        const line = lines[i].trim();
                        if (!line) continue;
                        const parts = line.split(',');
                        if (parts.length >= 5) {
                            const clean = (str) => str ? str.replace(/^"|"$/g, '').trim() : '';
                            try {
                                const itemData = {
                                    tipo: parts.length >= 6 ? clean(parts[0]) : "Reagente", // Ajuste para formato exportado
                                    localizacao: clean(parts[1]),
                                    nome: clean(parts[2]),
                                    quantidade: clean(parts[3]),
                                    unidade: clean(parts[4]),
                                    status: clean(parts[5]),
                                    updatedAt: Timestamp.now()
                                };
                                await addDoc(invCollection, itemData);
                                count++;
                            } catch (err) { }
                        }
                    }
                    alert(`${count} itens importados!`);
                    await loadDataFromFirebase();
                }
                document.getElementById('fileInput').value = '';
            };
            reader.readAsText(file);
        }

        // --- CONFIGURAÇÃO LOCAL ---
        function loadConfigLocal() {
            const savedConfig = localStorage.getItem('labConfig');
            if (savedConfig) configData = JSON.parse(savedConfig);
        }

        window.saveConfigLocal = function() {
            localStorage.setItem('labConfig', JSON.stringify(configData));
            populateAllSelects();
        }

        window.populateAllSelects = function() {
            populateSelect('tipo', configData.types);
            populateSelect('localizacao', configData.locations);
            populateSelect('statusManual', configData.statuses);
            
            const filterSelect = document.getElementById('filterType');
            const currentFilter = filterSelect.value;
            filterSelect.innerHTML = '<option value="Todos">Todos os Tipos</option>';
            configData.types.sort().forEach(t => {
                filterSelect.innerHTML += `<option value="${t}">${t}</option>`;
            });
            filterSelect.value = currentFilter;
        }

        function populateSelect(elementId, arrayData) {
            const select = document.getElementById(elementId);
            if(!select) return;
            const currentVal = select.value;
            select.innerHTML = '<option value="">Selecione...</option>';
            arrayData.sort().forEach(item => {
                const opt = document.createElement('option');
                opt.value = item;
                opt.textContent = item;
                select.appendChild(opt);
            });
            if (arrayData.includes(currentVal)) select.value = currentVal;
        }

        window.manageOption = function(category, action) {
            let targetArray, selectId, label;
            if (category === 'type') { targetArray = configData.types; selectId = 'tipo'; label = 'Tipo'; }
            if (category === 'loc') { targetArray = configData.locations; selectId = 'localizacao'; label = 'Localização'; }
            if (category === 'status') { targetArray = configData.statuses; selectId = 'statusManual'; label = 'Status'; }

            const selectEl = document.getElementById(selectId);
            const currentVal = selectEl.value;

            if (action === 'add') {
                const newVal = prompt(`Novo nome para ${label}:`);
                if (newVal && newVal.trim()) {
                    targetArray.push(newVal.trim());
                    saveConfigLocal();
                    selectEl.value = newVal.trim();
                }
            }
            if (action === 'edit') {
                if (!currentVal) return alert('Selecione uma opção para editar.');
                const newVal = prompt(`Editar nome de ${currentVal}:`, currentVal);
                if (newVal && newVal.trim() && newVal !== currentVal) {
                    const idx = targetArray.indexOf(currentVal);
                    targetArray[idx] = newVal.trim();
                    saveConfigLocal();
                    populateAllSelects();
                }
            }
            if (action === 'remove') {
                if (!currentVal) return alert('Selecione uma opção para remover.');
                if (confirm(`Remover "${currentVal}" da lista?`)) {
                    const idx = targetArray.indexOf(currentVal);
                    if (idx > -1) targetArray.splice(idx, 1);
                    saveConfigLocal();
                    selectEl.value = "";
                }
            }
        }

        // --- TABELA ---
        window.applyFilters = function() {
            const term = document.getElementById('searchInput').value.toLowerCase();
            const typeFilter = document.getElementById('filterType').value;

            let result = inventory.filter(item => {
                const nome = (item.nome || '').toLowerCase();
                const loc = (item.localizacao || '').toLowerCase();
                const tipo = item.tipo || '';
                return (nome.includes(term) || loc.includes(term)) && (typeFilter === 'Todos' || tipo === typeFilter);
            });

            result.sort((a, b) => {
                const tipoA = (a.tipo || '').toLowerCase(); const tipoB = (b.tipo || '').toLowerCase();
                if (tipoA < tipoB) return -1; if (tipoA > tipoB) return 1;
                return (a.nome || '').localeCompare(b.nome || '');
            });

            renderTable(result);
        }

        function renderTable(data) {
            const tbody = document.getElementById('inventoryTable');
            document.getElementById('totalItems').textContent = `${data.length} Itens`;

            if (data.length === 0) {
                tbody.innerHTML = `<tr><td colspan="7" style="text-align:center; padding: 3rem; color: #aaa;">Nenhum item encontrado.</td></tr>`;
                return;
            }

            tbody.innerHTML = data.map(item => {
                let badgeClass = 'badge-default';
                const st = (item.status || '').toLowerCase();
                if(st.includes('alto')) badgeClass = 'badge-alto';
                else if(st.includes('satisfat')) badgeClass = 'badge-satisfatorio';
                else if(st.includes('crít') || st.includes('crit')) badgeClass = 'badge-critico';

                const safeName = (item.nome || '').replace(/'/g, "\\'");
                
                return `
                    <tr>
                        <td><span class="badge badge-type">${item.tipo || 'Geral'}</span></td>
                        <td>${item.localizacao || '-'}</td>
                        <td style="font-weight: 500;">${item.nome}</td>
                        <td><span class="quantidade">${item.quantidade}</span></td>
                        <td>${item.unidade}</td>
                        <td><span class="badge ${badgeClass}">${item.status || '-'}</span></td>
                        <td>
                            <div class="action-buttons">
                                <button type="button" class="btn-icon" onclick="openEditModal('${item.id}')" title="Editar">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                                </button>
                                <button type="button" class="btn-icon delete" onclick="deleteItemById('${item.id}')" title="Apagar">
                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"></polyline><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path></svg>
                                </button>
                            </div>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // --- MODAL ---
        window.openModal = function() {
            editingId = null;
            document.getElementById('modalTitle').textContent = "Novo Item";
            document.getElementById('itemForm').reset();
            if(configData.types.length > 0) document.getElementById('tipo').value = configData.types[0];
            document.getElementById('statusManual').value = "Alto"; 
            document.getElementById('modal').classList.add('active');
        }

        window.openEditModal = function(id) {
            const item = inventory.find(i => i.id === id);
            if (!item) return;
            editingId = id;
            document.getElementById('modalTitle').textContent = "Editar Item";
            
            const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.value = val || ''; };
            setVal('tipo', item.tipo); setVal('nome', item.nome);
            setVal('quantidade', item.quantidade); setVal('unidade', item.unidade);
            setVal('localizacao', item.localizacao); setVal('statusManual', item.status);
            
            document.getElementById('modal').classList.add('active');
        }

        window.closeModal = function() { document.getElementById('modal').classList.remove('active'); }
        document.getElementById('modal').addEventListener('click', (e) => { if (e.target.id === 'modal') closeModal(); });
        document.getElementById('searchInput').addEventListener('input', applyFilters);

    </script>
</body>
</html>
